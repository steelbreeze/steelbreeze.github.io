(function(b){function d(g){var f=g.parent?d(g.parent):[];f.push(g);return f}var e={Shallow:1,Deep:2};function a(f,g,h){this.name=f;this.parent=g;this.history=h;this.transitions=[];if(this.parent&&!this.parent.initial){this.parent.initial=this}}a.prototype.isComplete=function(){return this.current||this.transitions};a.prototype.initialise=function(f){this.beginEntry();this.endEntry(f)};a.prototype.leave=function(){var g,f;if(this.current){this.current.leave()}if(this.exit){for(g=0,f=this.exit.length;g<f;++g){this.exit[g]()}}};a.prototype.beginEntry=function(){var g,f;if(this.entry){for(g=0,f=this.entry.length;g<f;++g){this.entry[g]()}}if(this.parent){this.parent.current=this}};a.prototype.endEntry=function(f){if(this.initial){(f||this.history?this.current||this.initial:this.initial).initialise(f||this.history===e.Deep?e.Deep:undefined)}if(this.isComplete()){this.process(f||this.history===e.Deep?e.Deep:undefined)}};a.prototype.toString=function(){return this.parent?this.parent.toString()+"."+this.name:this.name};a.prototype.process=function(h,j){var k,g,f;for(g=0,f=this.transitions.length;g<f;++g){if(this.transitions[g].guard(h)){if(k){throw"Multiple outbound transition guards evaluated true at "+this.toString()+" for "+h.toString()}k=this.transitions[g]}}if(k){k.traverse(h,j)}return k||(this.initial?this.current.process(h,j):false)};function c(j,k,h,g){this.guard=h=h||function(){return true};this.effect=g?(g instanceof Array?g:[g]):[];if(k){var m=d(j.parent),l=d(k),f=0;while(m.length>f&&l.length>f&&m[f]===l[f]){f++}this.source=m[f]||j;this.target=l.slice(f)}j.transitions.push(this)}c.prototype.traverse=function(j,k){var g,f,h;if(this.source){this.source.leave()}for(g=0,f=this.effect.length;g<f;++g){this.effect[g](j)}if(this.target){for(g=0,f=this.target.length;g<f;h=this.target[g],g++){this.target[g].beginEntry()}h.endEntry(k)}};b.History=e;b.State=a;b.Transition=c}(this.exports||this));